name: Shopple CiCd Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'android/**'
      - 'ios/**'
      - 'functions/**'
      - 'pubspec.yaml'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: 'stable'
  FLUTTER_VERSION: ''
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Stage 1: Detect Changes
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      flutter_changed: ${{ steps.filter.outputs.flutter }}
      functions_changed: ${{ steps.filter.outputs.functions }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            flutter:
              - 'lib/**'
              - 'test/**'
              - 'android/**'
              - 'ios/**'
              - 'pubspec.yaml'
            functions:
              - 'functions/**'

  # ===========================================================================
  # Stage 2: Quality Checks (Flutter)
  # ===========================================================================
  flutter-quality:
    name: Flutter Quality
    needs: detect-changes
    if: needs.detect-changes.outputs.flutter_changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Create Mock Config Files
        run: |
          mkdir -p lib
          cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return web;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: return ios;
                case TargetPlatform.macOS: return macos;
                default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');
              }
            }
            static const FirebaseOptions web = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions android = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions ios = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions macos = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
          }
          EOF
          touch .env

      - name: Install Dependencies
        run: flutter pub get

      - name: Analyze (Linting)
        run: flutter analyze --no-fatal-infos

      - name: Run Tests
        run: flutter test --coverage

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload Test Coverage

        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flutter-coverage
          path: coverage/lcov.info
          retention-days: 1

  # ===========================================================================
  # Stage 3: Quality Checks (Cloud Functions)
  # ===========================================================================
  functions-quality:
    name: Functions Quality
    needs: detect-changes
    if: needs.detect-changes.outputs.functions_changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Dependencies
        run: |
          cd functions
          npm ci

      - name: Lint Functions
        run: |
          cd functions
          npm run lint

  # ===========================================================================
  # Stage 4: Security Scans (SAST, SCA)
  # ===========================================================================
  
  security-gitleaks:
    name: Security - Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks Secret Scan
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
          ./gitleaks detect --source=. -v --config=gitleaks.toml 

  security-trivy:
    name: Security - Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy Dependency Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  security-mobsf:
    name: Security - Mobile SAST
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: MobSF Static Analysis
        uses: MobSF/mobsfscan@main
        with:
          args: '. --sarif --output mobsf-results.sarif --no-fail'
      - name: Upload MobSF Results
        uses: actions/upload-artifact@v4
        with:
          name: mobsf-scan-results
          path: mobsf-results.sarif
          retention-days: 1

  # ===========================================================================
  # Stage 5: Build Application (Testing & Production)
  # ===========================================================================
  build-app:
    name: Build App 
    needs: [detect-changes, flutter-quality, security-gitleaks, security-trivy, security-mobsf]
    if: (needs.detect-changes.outputs.flutter_changed == 'true' || github.event_name == 'workflow_dispatch') && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for version generation

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Create Mock Config Files
        run: |
          mkdir -p lib
          cat <<EOF > lib/firebase_options.dart
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) return web;
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: return ios;
                case TargetPlatform.macOS: return macos;
                default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');
              }
            }
            static const FirebaseOptions web = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions android = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions ios = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
            static const FirebaseOptions macos = FirebaseOptions(apiKey: 'mock', appId: 'mock', messagingSenderId: 'mock', projectId: 'mock');
          }
          EOF
          touch .env

          cat <<EOF > android/app/google-services.json
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "mock-project-id",
              "storage_bucket": "mock-project-id.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789012:android:mockandroidappid",
                  "android_client_info": {
                    "package_name": "com.example.shopple"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "mockapikey"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: Install Dependencies
        run: flutter pub get

      # Semantic Versioning: Auto-increment based on commit history
      - name: Generate Version
        id: version
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Generated Version Code: $BUILD_NUMBER"

      # Environment: Development/QA
      - name: Build Debug APK (Testing)
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "STREAM_CHAT_API_KEY=${{ secrets.STREAM_CHAT_API_KEY }}" > .env
          echo "STREAM_CHAT_API_SECRET=${{ secrets.STREAM_CHAT_API_SECRET }}" >> .env
          flutter build apk --debug --build-number=${BUILD_NUMBER} --dart-define-from-file=.env

      # Environment: Production
      - name: Build Release APK (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "STREAM_CHAT_API_KEY=${{ secrets.STREAM_CHAT_API_KEY }}" > .env
          echo "STREAM_CHAT_API_SECRET=${{ secrets.STREAM_CHAT_API_SECRET }}" >> .env
          flutter build apk --release --no-tree-shake-icons --build-number=${BUILD_NUMBER} --dart-define-from-file=.env

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build-${{ github.ref_name }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7

  # ===========================================================================
  # Stage 6: Release Management
  # ===========================================================================
  release:
    name: Release Manager
    needs: [build-app]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: app-build-${{ github.ref_name }}
          path: artifacts

      - name: Generate Release Tag
        id: tag
        run: |
          # Format: vYYYY.MM.DD-HHMM
          echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      # Release Channel: Stable
      - name: Create Production Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Production Release ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
          files: artifacts/app-release.apk
          body: |
            ## Production Release
            
            **Branch:** `main`
            **Build Type:** Release (Signed)
            
            ### Changelog
            ${{ github.event.head_commit.message }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Release Channel: Beta
      - name: Create Testing Release
        if: github.ref == 'refs/heads/develop'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}-beta
          name: Beta Build ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: true
          files: artifacts/app-debug.apk
          body: |
            ## Beta Release
            
            **Branch:** `develop`
            **Build Type:** Debug (Unsigned)
            
            > **Note:** This build is intended for internal testing and QA purposes only.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Stage 7: Notifications
  # ===========================================================================
  notify:
    name: Slack Notification
    needs: [release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ needs.release.result == 'success' && 'good' || 'danger' }}
          SLACK_TITLE: "Shopple Build Status: ${{ needs.release.result == 'success' && 'Success' || 'Failed' }}"
          SLACK_MESSAGE: |
            Build for ${{ github.ref_name }} completed.
            Status: ${{ needs.release.result }}
            Commit: ${{ github.sha }}
            Download: https://github.com/${{ github.repository }}/releases
          SLACK_FOOTER: "Shopple CI/CD"

  # ===========================================================================
  # Pipeline Summary
  # ===========================================================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, flutter-quality, functions-quality, security-gitleaks, security-trivy, security-mobsf, build-app, release, notify]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Shopple DevOps Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|:------:|-------------|" >> $GITHUB_STEP_SUMMARY
          
          get_status_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              cancelled) echo "⚪" ;;
              skipped) echo "⏭️" ;;
              *) echo "⏳" ;;
            esac
          }

          echo "| Flutter Quality | $(get_status_emoji '${{ needs.flutter-quality.result }}') | Tests & Analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions Quality | $(get_status_emoji '${{ needs.functions-quality.result }}') | Linting |" >> $GITHUB_STEP_SUMMARY
          echo "| Security - Secrets | $(get_status_emoji '${{ needs.security-gitleaks.result }}') | Gitleaks |" >> $GITHUB_STEP_SUMMARY
          echo "| Security - Dependencies | $(get_status_emoji '${{ needs.security-trivy.result }}') | Trivy |" >> $GITHUB_STEP_SUMMARY
          echo "| Security - Mobile | $(get_status_emoji '${{ needs.security-mobsf.result }}') | MobSF |" >> $GITHUB_STEP_SUMMARY
          echo "| Build App | $(get_status_emoji '${{ needs.build-app.result }}') | APK Build (${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | $(get_status_emoji '${{ needs.release.result }}') | GitHub Release |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification | $(get_status_emoji '${{ needs.notify.result }}') | Slack Alert |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Release](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
